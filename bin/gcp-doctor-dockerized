#!/bin/bash
IMAGE="us-docker.pkg.dev/gcp-doctor-repo/release/gcp-doctor"
VERSION=$(curl -sf https://storage.googleapis.com/gcp-doctor/default-version)
CWD=$(pwd)
[ -t 0 ] && USE_TTY="-it" || USE_TTY=""
mkdir -p "$HOME/.cache/gcp-doctor-dockerized"
if [ -f "$HOME/.docker/config.json" ] &&
  grep us-docker.pkg.dev "$HOME/.docker/config.json" >/dev/null; then :; else
    gcloud auth configure-docker us-docker.pkg.dev
fi
exec docker run "$USE_TTY" \
  --rm \
  -u "$(id -u):$(id -g)" \
  -e "USER=$(id -n -u)" \
  -e "GROUP=$(id -n -g)" \
  -e "SHELL=/bin/bash" \
  -e HOME -e LANG -e GOOGLE_AUTH_TOKEN -e CLOUD_SHELL \
  -v "$HOME/.cache/gcp-doctor-dockerized:$HOME/.cache/gcp-doctor" \
  -v "$CWD:$CWD" -w "$CWD" \
  "$IMAGE:$VERSION" /opt/gcp-doctor/bin/gcp-doctor "$@"
