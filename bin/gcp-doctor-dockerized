#!/bin/bash
set -e
IMAGE="us-docker.pkg.dev/gcp-doctor-repo/release/gcp-doctor"
VERSION=$(curl -sf https://storage.googleapis.com/gcp-doctor/default-version)
CWD=$(pwd)
[ -t 0 ] && USE_TTY="-it" || USE_TTY=""
mkdir -p "$HOME/.cache/gcp-doctor-dockerized"
# If we don't have the image yet, make sure that the user is logged in
# otherwise the docker pull will fail (without telling what the problem is)
if ! docker inspect -f 'present' "$IMAGE:$VERSION" >/dev/null 2>&1; then
  gcloud auth configure-docker "us-docker.pkg.dev" >/dev/null 2>&1
  GCLOUD_ACCOUNT=$(gcloud config get-value account)
  if [[ -z "$GCLOUD_ACCOUNT" ]] || [[ $(gcloud auth describe "$GCLOUD_ACCOUNT" --format="value(valid)") != "True" ]]; then
    gcloud auth login
  fi
fi
exec docker run "$USE_TTY" \
  --rm \
  -u "$(id -u):$(id -g)" \
  -e "USER=$(id -n -u)" \
  -e "GROUP=$(id -n -g)" \
  -e "SHELL=/bin/bash" \
  -e HOME -e LANG -e GOOGLE_AUTH_TOKEN -e CLOUD_SHELL \
  -v "$HOME/.cache/gcp-doctor-dockerized:$HOME/.cache/gcp-doctor" \
  -v "$CWD:$CWD" -w "$CWD" \
  "$IMAGE:$VERSION" /opt/gcp-doctor/bin/gcp-doctor "$@"
