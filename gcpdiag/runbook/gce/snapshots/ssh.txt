project: gcpdiag-gce-faultyssh-runbook, parameters: {check_os_login=true,name=faulty-linux-
ssh,principal=cannotssh@example.com,project_id=gcpdiag-gce-faultyssh-
runbook,tunnel_through_iap=true,zone=europe-west2-a}

gce/ssh: Provides a comprehensive analysis of common issues which affects SSH connectivity to VMs.

  This runbook focuses on a range of potential problems for both Windows and Linux VMs on
  Google Cloud Platform. By conducting a series of checks, the runbook aims to pinpoint the
  root cause of SSH access difficulties.

  The following areas are examined:

  - VM Instance Status: Evaluates the VM's current state, performance - ensuring that it is running
    and not impaired by high CPU usage, insufficient memory, or disk space issues that might disrupt
    normal SSH operations.

  - User Permissions: Checks for the necessary Google Cloud IAM permissions that are required to
    leverage OS Login features and to use metadata-based SSH keys for authentication.

  - VM Configuration: Analyzes the VM's metadata settings to confirm the inclusion of SSH keys,
    flags and other essential configuration details that facilitate SSH access.

  - GCE Network Connectivity Tests: Reviews applicable firewall rules to verify that there are no
    network barriers preventing SSH access to the VM.

  - Internal Guest OS Checks: Analysis available Guest OS metrics or logs to detect any
    misconfigurations or service disruptions that could be obstructing SSH functionality.
    
[START]: Starting SSH diagnostics
[INFO]: Will check for OS login configuration
[INFO]: Checks will use ip 35.235.240.0/20 as the source IP
[INFO]: Will check for IAP configuration
[INFO]: Will use ops agent metrics for relevant assessments
[AUTOMATED STEP]: Verifying VM is in the RUNNING state...

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [OK]
     [REASON]
     The GCE VM faulty-linux-ssh is in the expected state: RUNNING.

[COMPOSITE STEP]: Evaluating VM memory, CPU, and disk performance...
[AUTOMATED STEP]: Verifying VM memory utilization is within optimal levels...

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     Memory utilization on this VM has reached levels that may compromise its VM application performance.

     [REMEDIATION]
     Elevated memory usage can result in slow or unresponsive or termimated applications.
     Consider enhancing the VM's memory capacity by changing to a machine type with more memory.
     Guidance on stopping and changing the machine type can be found here:
     - Changing machine type: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     For deeper analysis of memory issues:

     Additionally, use the GCE observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#memory_utilization

     Or connect via the Serial Console if SSH is not available to mitigate the issue.
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[AUTOMATED STEP]: Verifying VM's Boot disk space utilization is within optimal levels.
[AUTOMATED STEP]: Verifying VM CPU utilization is within optimal levels

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     CPU utilization on this VM has surpassed recommended operational levels,
     which may affect its performance and SSH connectivity.

     [REMEDIATION]
     Excessive CPU usage can lead to performance bottlenecks. Consider resizing the VM to a more
     powerful machine type with higher CPU capabilities.
     Detailed instructions for resizing and restarting VMs are available here:
     - Stopping a VM: https://cloud.google.com/compute/docs/instances/stop-start-instance
     - Resizing a VM: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     Additionally, use the GCE observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#access_vm_observability_metrics
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#process_utilization

     Alternatively, you can connect via serial console if SSH is unvailable to stop offending processes
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console.

[GATEWAY]: Identifying Guest OS type...
[INFO]: Detected Linux VM. Proceeding with Linux-specific diagnostics.
[COMPOSITE STEP]: Analyzing serial logs for common linux guest os and application issues...
[AUTOMATED STEP]: Initiating kernel panic check on the Guest OS.


   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [UNCERTAIN]
     [REASON]
     Lack of serial log data prevented a thorough assessment of the VM's operational state. Result is
     inconclusive

     [REMEDIATION]
     Confirm the VM's operational status by reviewing available serial logs.
     Address any detected guest OS issues using the provided documentation,
     keeping in mind certain guest OS faults may be beyond GCP's support scope.
     - Viewing Serial Port Output: https://cloud.google.com/compute/docs/troubleshooting/viewing-serial-port-output
     - Resolving Kernel Panic:
     https://cloud.google.com/compute/docs/troubleshooting/kernel-panic#resolve_the_kernel_panic_error
     - GCP Support Scope: https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope

[AUTOMATED STEP]: Examining SSHD functionality via serial logs.


   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [OK]
     [REASON]
     Detected that SSHD is running within the VM

[AUTOMATED STEP]: Analyzing SSHGuard intrusion detection functionality on the VM (if any)


   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [UNCERTAIN]
     [REASON]
     Unable to confirm SSHGuard activity due to lack of serial log data.

     [REMEDIATION]
     If SSHGuard or similar application is a concern,
     manually inspect its configuration via the interactive serial console:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[COMPOSITE STEP]: Verifying overall user permissions for SSH access...

    Note: Only roles granted at the project level are checked. Permissions inherited from
    ancestor resources such as folder(s) or organization and groups are not checked.
[AUTOMATED STEP]: Verifying user access to Cloud Console...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     To access Compute Engine via the Google Cloud console (i.e. SSH-in-browser),
     the user must have "compute.projects.get" permission.

     [REMEDIATION]
     Review the permissions guide for accessing Compute Engine resources:
     https://cloud.google.com/compute/docs/access/iam#console_permission

[AUTOMATED STEP]: Verifying instance retrieval permissions...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     The authenticated user none:cannotssh@example.com does not have the permissions needed to manage instances.
     The following permissions are required: ['compute.instances.get', 'compute.instances.use'].

     [REMEDIATION]
     To remedy this, ensure the user none:cannotssh@example.com is granted a role encompassing the necessary permissions:
     - Permissions needed: ['compute.instances.get', 'compute.instances.use']
     For guidance on assigning instance admin roles, consult:
     https://cloud.google.com/compute/docs/access/iam#connectinginstanceadmin

[GATEWAY]: Identifying OS Login Setup.
[INFO]: OS login setup is desired, Hence OS login related configurations
[AUTOMATED STEP]: Verifying that OS Login is set to `True` for the VM.


   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     OS Login is intended for use, but it has been disabled on this VM.

     [REMEDIATION]
     To utilize OS Login, you need to enable it by setting the `enable-oslogin` flag in the VM's
     metadata to `TRUE`.For detailed instructions on enabling OS Login,
     refer to: https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#enable_os_login

[AUTOMATED STEP]: Evaluating OS Login permissions for the user...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "none:cannotssh@example.com" is missing at least one of the required OS Login roles:
     roles/compute.osLogin, roles/compute.osAdminLogin, or roles/owner.

     [REMEDIATION]
     Assign "none:cannotssh@example.com" one of the role required to have OS Login privileges.
     For more information:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Evaluating user permissions for the service account...

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     "none:cannotssh@example.com" does not have the "roles/iam.serviceAccountUser" role or custom roles which has the
     constituent permissions required to be able to impersonate the service account "12345601-compute@developer.gserviceaccount.com".

     [REMEDIATION]
     Assign the "roles/iam.serviceAccountUser" role to "none:cannotssh@example.com".
     Guidelines:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Evaluating IAP Tunnel user permissions...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "none:cannotssh@example.com" lacks the "roles/iap.tunnelResourceAccessor" role necessary to Tunnel through IAP for access.

     [REMEDIATION]
     Ensure "none:cannotssh@example.com" is granted the "roles/iap.tunnelResourceAccessor" role. Resource guide:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[COMPOSITE STEP]: Evaluating VPC network firewall rules for SSH access...
[AUTOMATED STEP]: Evaluating VPC network traffic rules...

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [OK]
     [REASON]
     Ingress Traffic from source IP/CIDR 35.235.240.0/20, tcp:22 to the GCE
     instance faulty-linux-ssh is allowed by: vpc firewall rule: gce-secured-instance-test-allow

[END]: Finalizing SSH diagnostics...


project: gcpdiag-gce-faultyssh-runbook, parameters: {check_os_login=true,name=valid-linux-
ssh,principal=canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com,project_id=gcpdiag-gce-
faultyssh-runbook,tunnel_through_iap=true,zone=europe-west2-a}

gce/ssh: Provides a comprehensive analysis of common issues which affects SSH connectivity to VMs.

  This runbook focuses on a range of potential problems for both Windows and Linux VMs on
  Google Cloud Platform. By conducting a series of checks, the runbook aims to pinpoint the
  root cause of SSH access difficulties.

  The following areas are examined:

  - VM Instance Status: Evaluates the VM's current state, performance - ensuring that it is running
    and not impaired by high CPU usage, insufficient memory, or disk space issues that might disrupt
    normal SSH operations.

  - User Permissions: Checks for the necessary Google Cloud IAM permissions that are required to
    leverage OS Login features and to use metadata-based SSH keys for authentication.

  - VM Configuration: Analyzes the VM's metadata settings to confirm the inclusion of SSH keys,
    flags and other essential configuration details that facilitate SSH access.

  - GCE Network Connectivity Tests: Reviews applicable firewall rules to verify that there are no
    network barriers preventing SSH access to the VM.

  - Internal Guest OS Checks: Analysis available Guest OS metrics or logs to detect any
    misconfigurations or service disruptions that could be obstructing SSH functionality.
    
[START]: Starting SSH diagnostics
[INFO]: Will check for OS login configuration
[INFO]: Checks will use ip 35.235.240.0/20 as the source IP
[INFO]: Will check for IAP configuration
[INFO]: Checks will use serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com as the authenticated
principal in Cloud Console / gcloud (incl. impersonated service account)
[INFO]: Will use ops agent metrics for relevant assessments
[AUTOMATED STEP]: Verifying VM is in the RUNNING state...

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     The GCE VM valid-linux-ssh is in the expected state: RUNNING.

[COMPOSITE STEP]: Evaluating VM memory, CPU, and disk performance...
[AUTOMATED STEP]: Verifying VM memory utilization is within optimal levels...

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [FAIL]
     [REASON]
     Memory utilization on this VM has reached levels that may compromise its VM application performance.

     [REMEDIATION]
     Elevated memory usage can result in slow or unresponsive or termimated applications.
     Consider enhancing the VM's memory capacity by changing to a machine type with more memory.
     Guidance on stopping and changing the machine type can be found here:
     - Changing machine type: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     For deeper analysis of memory issues:

     Additionally, use the GCE observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#memory_utilization

     Or connect via the Serial Console if SSH is not available to mitigate the issue.
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[AUTOMATED STEP]: Verifying VM's Boot disk space utilization is within optimal levels.
[AUTOMATED STEP]: Verifying VM CPU utilization is within optimal levels

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [FAIL]
     [REASON]
     CPU utilization on this VM has surpassed recommended operational levels,
     which may affect its performance and SSH connectivity.

     [REMEDIATION]
     Excessive CPU usage can lead to performance bottlenecks. Consider resizing the VM to a more
     powerful machine type with higher CPU capabilities.
     Detailed instructions for resizing and restarting VMs are available here:
     - Stopping a VM: https://cloud.google.com/compute/docs/instances/stop-start-instance
     - Resizing a VM: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     Additionally, use the GCE observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#access_vm_observability_metrics
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#process_utilization

     Alternatively, you can connect via serial console if SSH is unvailable to stop offending processes
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console.

[GATEWAY]: Identifying Guest OS type...
[INFO]: Detected Linux VM. Proceeding with Linux-specific diagnostics.
[COMPOSITE STEP]: Analyzing serial logs for common linux guest os and application issues...
[AUTOMATED STEP]: Initiating kernel panic check on the Guest OS.


   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [UNCERTAIN]
     [REASON]
     Lack of serial log data prevented a thorough assessment of the VM's operational state. Result is
     inconclusive

     [REMEDIATION]
     Confirm the VM's operational status by reviewing available serial logs.
     Address any detected guest OS issues using the provided documentation,
     keeping in mind certain guest OS faults may be beyond GCP's support scope.
     - Viewing Serial Port Output: https://cloud.google.com/compute/docs/troubleshooting/viewing-serial-port-output
     - Resolving Kernel Panic:
     https://cloud.google.com/compute/docs/troubleshooting/kernel-panic#resolve_the_kernel_panic_error
     - GCP Support Scope: https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope

[AUTOMATED STEP]: Examining SSHD functionality via serial logs.


   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     Detected that SSHD is running within the VM

[AUTOMATED STEP]: Analyzing SSHGuard intrusion detection functionality on the VM (if any)


   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [UNCERTAIN]
     [REASON]
     Unable to confirm SSHGuard activity due to lack of serial log data.

     [REMEDIATION]
     If SSHGuard or similar application is a concern,
     manually inspect its configuration via the interactive serial console:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[COMPOSITE STEP]: Verifying overall user permissions for SSH access...

    Note: Only roles granted at the project level are checked. Permissions inherited from
    ancestor resources such as folder(s) or organization and groups are not checked.
[AUTOMATED STEP]: Verifying user access to Cloud Console...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     To access Compute Engine via the Google Cloud console (i.e. SSH-in-browser),
     the user must have "compute.projects.get" permission.

     [REMEDIATION]
     Review the permissions guide for accessing Compute Engine resources:
     https://cloud.google.com/compute/docs/access/iam#console_permission

[AUTOMATED STEP]: Verifying instance retrieval permissions...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     The authenticated user serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com does not have the permissions needed to manage instances.
     The following permissions are required: ['compute.instances.get', 'compute.instances.use'].

     [REMEDIATION]
     To remedy this, ensure the user serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com is granted a role encompassing the necessary permissions:
     - Permissions needed: ['compute.instances.get', 'compute.instances.use']
     For guidance on assigning instance admin roles, consult:
     https://cloud.google.com/compute/docs/access/iam#connectinginstanceadmin

[GATEWAY]: Identifying OS Login Setup.
[INFO]: OS login setup is desired, Hence OS login related configurations
[AUTOMATED STEP]: Verifying that OS Login is set to `True` for the VM.


   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     OS Login is active on this VM, as indicated by the `enable-oslogin` flag being set to `True`.
     Your VM can use OS Login-based access.

[AUTOMATED STEP]: Evaluating OS Login permissions for the user...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" is missing at least one of the required OS Login roles:
     roles/compute.osLogin, roles/compute.osAdminLogin, or roles/owner.

     [REMEDIATION]
     Assign "serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" one of the role required to have OS Login privileges.
     For more information:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Evaluating user permissions for the service account...

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [FAIL]
     [REASON]
     "serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" does not have the "roles/iam.serviceAccountUser" role or custom roles which has the
     constituent permissions required to be able to impersonate the service account "12345601-compute@developer.gserviceaccount.com".

     [REMEDIATION]
     Assign the "roles/iam.serviceAccountUser" role to "serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com".
     Guidelines:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Evaluating IAP Tunnel user permissions...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" lacks the "roles/iap.tunnelResourceAccessor" role necessary to Tunnel through IAP for access.

     [REMEDIATION]
     Ensure "serviceaccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" is granted the "roles/iap.tunnelResourceAccessor" role. Resource guide:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[COMPOSITE STEP]: Evaluating VPC network firewall rules for SSH access...
[AUTOMATED STEP]: Evaluating VPC network traffic rules...

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     Ingress Traffic from source IP/CIDR 35.235.240.0/20, tcp:22 to the GCE
     instance valid-linux-ssh is allowed by: vpc firewall rule: default-allow-ssh

[END]: Finalizing SSH diagnostics...


project: gcpdiag-gce-faultyssh-runbook, parameters:
{check_os_login=false,local_user=no_user,name=faulty-windows-
ssh,principal=cannot@example.com,project_id=gcpdiag-gce-faultyssh-
runbook,src_ip=0.0.0.0,tunnel_through_iap=false,zone=europe-west2-a}

gce/ssh: Provides a comprehensive analysis of common issues which affects SSH connectivity to VMs.

  This runbook focuses on a range of potential problems for both Windows and Linux VMs on
  Google Cloud Platform. By conducting a series of checks, the runbook aims to pinpoint the
  root cause of SSH access difficulties.

  The following areas are examined:

  - VM Instance Status: Evaluates the VM's current state, performance - ensuring that it is running
    and not impaired by high CPU usage, insufficient memory, or disk space issues that might disrupt
    normal SSH operations.

  - User Permissions: Checks for the necessary Google Cloud IAM permissions that are required to
    leverage OS Login features and to use metadata-based SSH keys for authentication.

  - VM Configuration: Analyzes the VM's metadata settings to confirm the inclusion of SSH keys,
    flags and other essential configuration details that facilitate SSH access.

  - GCE Network Connectivity Tests: Reviews applicable firewall rules to verify that there are no
    network barriers preventing SSH access to the VM.

  - Internal Guest OS Checks: Analysis available Guest OS metrics or logs to detect any
    misconfigurations or service disruptions that could be obstructing SSH functionality.
    
[START]: Starting SSH diagnostics
[INFO]: Will check for Metadata based SSH key configuration
[INFO]: Checks will use ip 0.0.0.0 as the source IP
[INFO]: Will not check for IAP for TCP forwarding configuration
[INFO]: Local User: no_user will be used examine metadata-based SSH Key configuration
[INFO]: Will use ops agent metrics for relevant assessments
[AUTOMATED STEP]: Verifying VM is in the RUNNING state...

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     The GCE VM faulty-windows-ssh is in an undesired state: TERMINATED.

     [REMEDIATION]
     This step failed because GCE Virtual Machine faulty-windows-ssh is expected to be in a RUNNING state:

     To initiate the lifecycle transition from TERMINATED to RUNNING state follow guide [1]

     If you encounter any difficulties during the startup process, consult the troubleshooting
     documentation to identify and resolve potential startup issues [2]
     Resources:
     [1] https://cloud.google.com/compute/docs/instances/stop-start-instance#restart-vm
     [2] https://cloud.google.com/compute/docs/troubleshooting/vm-startup#identify_the_reason_why_the_boot_disk_isnt_booting

[COMPOSITE STEP]: Evaluating VM memory, CPU, and disk performance...
[AUTOMATED STEP]: Verifying VM memory utilization is within optimal levels...

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     Memory utilization on this VM has reached levels that may compromise its VM application performance.

     [REMEDIATION]
     Elevated memory usage can result in slow or unresponsive or termimated applications.
     Consider enhancing the VM's memory capacity by changing to a machine type with more memory.
     Guidance on stopping and changing the machine type can be found here:
     - Changing machine type: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     For deeper analysis of memory issues:

     Additionally, use the GCE observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#memory_utilization

     Or connect via the Serial Console if SSH is not available to mitigate the issue.
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[AUTOMATED STEP]: Verifying VM's Boot disk space utilization is within optimal levels.
[AUTOMATED STEP]: Verifying VM CPU utilization is within optimal levels

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     CPU utilization on this VM has surpassed recommended operational levels,
     which may affect its performance and SSH connectivity.

     [REMEDIATION]
     Excessive CPU usage can lead to performance bottlenecks. Consider resizing the VM to a more
     powerful machine type with higher CPU capabilities.
     Detailed instructions for resizing and restarting VMs are available here:
     - Stopping a VM: https://cloud.google.com/compute/docs/instances/stop-start-instance
     - Resizing a VM: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     Additionally, use the GCE observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#access_vm_observability_metrics
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#process_utilization

     Alternatively, you can connect via serial console if SSH is unvailable to stop offending processes
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console.

[GATEWAY]: Identifying Guest OS type...
[INFO]: Detected Windows VM. Proceeding with Windows-specific diagnostics.
[COMPOSITE STEP]: Analyzing Windows Guest OS boot-up and SSH agent status...
[AUTOMATED STEP]: Verifying VM metadata value...

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     SSH metadata `enable-windows-ssh` is not configured for this Windows VM,
     preventing SSH access.

     [REMEDIATION]
     To enable SSH access for your Windows VM, you must configure SSH metadata settings appropriately.
     Please consult our guide on enabling SSH for Windows instances for step-by-step instructions:
     https://cloud.google.com/compute/docs/connect/windows-ssh#enable

[AUTOMATED STEP]: Verifying bootup pr


   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [UNCERTAIN]
     [REASON]
     Lack of serial log data prevented a thorough assessment of the VM's operational state. Result is
     inconclusive

     [REMEDIATION]
     Consulting the troubleshooting guide to investigate windows boot up issues. [1][2]

     Resources:
     [1] https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-windows

     Connecting to the Windows Special Administrative Console (SAC) to troubleshoot bootup issues.
     [2] https://cloud.google.com/compute/docs/instances/connecting-to-sac

     GCP Support Scope
     https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope

[MANUAL STEP]: Manually verify if the necessary Google guest agents, especially `google-compute-engine-ssh`,
are operational on the VM.


   -                                                                      [SKIP]
     [REASON]
     Human Tasks was skipped as runbook is running autonomous mode
[COMPOSITE STEP]: Verifying overall user permissions for SSH access...

    Note: Only roles granted at the project level are checked. Permissions inherited from
    ancestor resources such as folder(s) or organization and groups are not checked.
[AUTOMATED STEP]: Verifying user access to Cloud Console...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     To access Compute Engine via the Google Cloud console (i.e. SSH-in-browser),
     the user must have "compute.projects.get" permission.

     [REMEDIATION]
     Review the permissions guide for accessing Compute Engine resources:
     https://cloud.google.com/compute/docs/access/iam#console_permission

[AUTOMATED STEP]: Verifying instance retrieval permissions...

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     The authenticated user none:cannot@example.com does not have the permissions needed to manage instances.
     The following permissions are required: ['compute.instances.get', 'compute.instances.use'].

     [REMEDIATION]
     To remedy this, ensure the user none:cannot@example.com is granted a role encompassing the necessary permissions:
     - Permissions needed: ['compute.instances.get', 'compute.instances.use']
     For guidance on assigning instance admin roles, consult:
     https://cloud.google.com/compute/docs/access/iam#connectinginstanceadmin

[GATEWAY]: Identifying OS Login Setup.
[COMPOSITE STEP]: Evaluating VPC network firewall rules for SSH access...
[AUTOMATED STEP]: Evaluating VPC network traffic rules...

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [OK]
     [REASON]
     Ingress Traffic from source IP/CIDR 0.0.0.0, tcp:22 to the GCE instance faulty-windows-ssh is allowed by: vpc firewall rule: gce-secured-instance-test-allow

[END]: Finalizing SSH diagnostics...


